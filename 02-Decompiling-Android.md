# Week 2: Domain Background and Data (a first look)

## Topics

* What is Malware? What does it do?
* Identifying Malware by code structure: Libraries, APIs, and network
  calls.
* Decompiling android bytecode to Smali code (and interpreting it).

## Apks and Smali code

Android apps are written in Java and compiled to *Dalvik* bytecode,
and distributed in zipped files called *apk*s, to be run on a
phone. The bytecode is denoted with the `.dex` file suffix. To
statically analyze android code, we need to decompile these `dex`
files to a representation in what's called *Smali code*. Since we will
be attempting to understand what code does from Smali files, we need
to understand how Smali represents Java source code.

1. To download `apk` files directly on your computer, you can use
   [www.apkpure.com](https://www.apkpure.com). To obtain an apk file from the
   play store, you would need to install it on a phone, then grab the
   file from the mobile device (not recommended).
2. To decompile an Android Apk to Smali code, download and use
   [ApkTool](https://ibotpeaches.github.io/Apktool/). Follow the
   download instructions and run it on a sample (benign) android app.

## Intro to Graphs

We will use python and
[networkX](https://networkx.github.io/documentation/stable/index.html)
to work and visualize graph structures. Install the package on your
machine and work through the
[tutorial](https://networkx.github.io/documentation/stable/tutorial.html)
in the documentation. 

## Additional Reading

* Read
  [slides](http://www.syssec-project.eu/m/page-media/158/syssec-summer-school-Android-Code-Injection.pdf)
  on the process of creating Smali code. The slides more generally
  speak about recompiling an App after changing Smali code (perhaps
  injecting malicious code). While interesting, you only need to focus
  on the slides decribing the correspondence between Java source code
  and Smali code. [This](http://pages.cpsc.ucalgary.ca/~joel.reardon/mobile/smali-cheat.pdf) 
  is also a very handy guide for quick access to smali syntax.
* Read this
  [post](https://duo.com/decipher/hunting-malicious-npm-packages)
  about searching for malicious Javascript using static code
  analysis. This article uses the dependency graph of different
  programs to emphasize how much unknown code you may be installing,
  even when installing a "trusted" library (`npm` is javascripts package
  manager, much like python's `pip`).
    
## Discussion questions from the reading/data

* Download a “HelloWorld” apk from apkpure and convert it to smali
  code. Find similar source (Java) code for an HelloWorld app and
  understand all the pieces of the smali code. To find an app, search
  apkpure and github.
* Pick 10 (known) Android apps from the apk-pure, download the apk, and
  convert to smali code.
  
### Statistics on Smali code

Try answering the following questions related to performing an EDA on
Smali code. In particular, figure out if you can answer them using the
decompiled APK. Also, keep in mind that the apps that you have
downloaded from apkpure.com are benign (and not malware) so what we
are doing is trying to understand some patterns these apps exhibit.

* What are the most common API calls overall/individually for an App?
* If you know what an App does (say a document viewer), does this explain the API calls present/absent in this App.
* Co-occurrences of API calls?
* How many base java methods occur in each application?
* Can you find out some API calls that are domain-specific?
* Average number of methods per App/average number of API calls per method?
 
This is not an exhaustive list of things you can try. Feel free to
explore other various ways. Once you have done this for a bunch of
apps you can also take one app of your choice and try to see how its
structure (methods, API calls, invocation methods, etc) vary from the
average.

Food for thought: Try to figure out what properties you can use to
find out if an App is malicious.

*Note*: The code you write for these questions will be useful
throughout the quarter!

### Graphs and Smali Code Question

* For a given application’s smali code, create the (directed) inheritance graph of the application:
  - The nodes are classes.
  - Class A is connected to Class B if Class A is a subclass of Class B.
